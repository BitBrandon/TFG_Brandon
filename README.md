# üöÄ TFG: Arquitectura de Servicios Dockerizados y Centralizaci√≥n de Identidades

¬°Bienvenido/a! Este repositorio contiene mi Trabajo de Fin de Grado, donde aprender√°s a desplegar y gestionar una arquitectura completa de servicios utilizando Docker, integrando autenticaci√≥n centralizada mediante OpenLDAP y simulando un entorno realista de empresa.

üë®‚Äçüíª Autor: BitBrandon

---

## üóÇÔ∏è Tabla de Contenidos

1. [Introducci√≥n](#introducci√≥n)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
   - [Diagrama de Contexto](#diagrama-de-contexto)
   - [Diagrama de Contenedores (C4)](#diagrama-de-contenedores-c4)
3. [Tecnolog√≠as Utilizadas](#tecnolog√≠as-utilizadas)
4. [Estructura del Proyecto](#estructura-del-proyecto)
5. [Instalaci√≥n y Despliegue](#instalaci√≥n-y-despliegue)
6. [Acceso a Clientes y Pruebas LDAP](#acceso-a-clientes-y-pruebas-ldap)
7. [Scripts de Gesti√≥n y Automatizaci√≥n](#scripts-de-gesti√≥n-y-automatizaci√≥n)
8. [Uso y Ejemplos Pr√°cticos](#uso-y-ejemplos-pr√°cticos)
9. [Pruebas y Validaci√≥n](#pruebas-y-validaci√≥n)
10. [Resoluci√≥n de Problemas](#resoluci√≥n-de-problemas)
11. [Conclusi√≥n Final](#conclusi√≥n-final)
12. [Agradecimientos](#agradecimientos)
13. [Roadmap y Futuras Mejoras](#roadmap-y-futuras-mejoras)
14. [Referencias](#referencias)

---

## üëã Introducci√≥n

Este proyecto muestra c√≥mo dise√±ar, desplegar y gestionar una infraestructura moderna basada en contenedores Docker. El objetivo es simular un entorno empresarial donde todos los servicios (bases de datos, LDAP, front/back, clientes, etc.) est√°n aislados y orquestados, centralizando la autenticaci√≥n y la gesti√≥n de usuarios mediante LDAP y NSS/PAM.

---

## üèóÔ∏è Arquitectura del Sistema

### üåê Diagrama de Contexto

```
+------------------+       HTTP/Web      +--------------------------+
|                  |-------------------> |                          |
|   üë§ Usuario     |                     |  Sistema de Servicios    |
|                  |<------------------- |  Docker (TFG_Brandon)    |
+------------------+      Web UI         +--------------------------+
```

### üì¶ Diagrama de Contenedores (C4)

```
+------------------+    HTTP   +---------------------+    +-------------------+
|                  | --------> |  Frontend (PHP/JS)  |    |                   |
|   üë§ Usuario     |           +---------------------+    |                   |
+------------------+                 |                   |                   |
                                     | REST API (HTTP)   |                   |
                                     v                   |                   |
                              +-------------------+      |                   |
                              | Backend (Flask)   |------+                   |
                              | Python            |   SQL (3306)            |
                              +-------------------+      |                   |
                                     |                   v                   |
                              +-------------------+  +-------------------+   |
                              |   MySQL/MariaDB   |  |  Scripts Bash     |   |
                              +-------------------+  +-------------------+   |
```

---

## üõ†Ô∏è Tecnolog√≠as Utilizadas

- **Lenguajes:** PHP, Python (Flask), Shell Script, HTML, CSS
- **Contenedores:** Docker, Docker Compose
- **Base de datos:** MySQL 8.0/MariaDB
- **Autenticaci√≥n centralizada:** OpenLDAP, NSS/PAM LDAP
- **Frontend:** PHP/HTML/CSS/JS
- **Backend:** Python (Flask)
- **Scripts:** Bash para gesti√≥n y automatizaci√≥n

---

## üóÉÔ∏è Estructura del Proyecto

```
TFG_Brandon/
‚îú‚îÄ‚îÄ backend/              # Backend Python/Flask
‚îÇ   ‚îú‚îÄ‚îÄ app.py
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ frontend/             # Frontend PHP/HTML/CSS
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ styles.css
‚îÇ   ‚îî‚îÄ‚îÄ main.js
‚îú‚îÄ‚îÄ db/                   # Scripts de base de datos
‚îÇ   ‚îî‚îÄ‚îÄ init.sql
‚îú‚îÄ‚îÄ ldap/                 # Configuraci√≥n y vol√∫menes de LDAP
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ data/
‚îú‚îÄ‚îÄ scripts/              # Scripts de gesti√≥n
‚îÇ   ‚îú‚îÄ‚îÄ arrancar.sh
‚îÇ   ‚îú‚îÄ‚îÄ reinicio.sh
‚îÇ   ‚îî‚îÄ‚îÄ apagar.sh
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ .env
‚îî‚îÄ‚îÄ ...
```

---

## ‚ö° Instalaci√≥n y Despliegue

### Requisitos previos

- Docker y Docker Compose instalados
- Git

### Pasos r√°pidos

1. **Clona el repositorio**
   ```bash
   git clone https://github.com/BitBrandon/TFG_Brandon.git
   cd TFG_Brandon
   ```

2. **Configura tu entorno**
   ```bash
   cp .env.example .env
   # Edita .env seg√∫n lo que necesites (puertos, claves, etc.)
   ```

3. **Arranca los servicios**
   ```bash
   docker-compose up --build -d
   # O usa el script
   ./scripts/arrancar.sh
   ```

4. **¬°Listo!**
   - Frontend: [http://localhost:8080](http://localhost:8080)
   - API: [http://localhost:5000/api](http://localhost:5000/api)
   - MySQL: puerto 3306

---

## üì° Acceso a Clientes y Pruebas LDAP

### üñ•Ô∏è Acceso a clientes simulados por SSH (desde el host)

Cada cliente est√° accesible v√≠a SSH desde tu m√°quina anfitriona (host) usando los siguientes puertos mapeados:

| Contenedor           | Puerto SSH | Hostname interno               |
|----------------------|------------|-------------------------------|
| cliente-trabajador1  | 2221       | trabajador1.mayorista.local   |
| cliente-trabajador2  | 2222       | trabajador2.mayorista.local   |
| cliente-jefeit       | 2223       | jefeit.mayorista.local        |
| cliente-jefe         | 2224       | jefe.mayorista.local          |

Con√©ctate as√≠ desde tu host:
```bash
ssh juan@localhost -p 2221
```
*(Sustituye `juan` por cualquier usuario LDAP v√°lido)*

---

### üîÑ Acceso SSH entre clientes (por red Docker interna)

Los contenedores pueden conectarse entre s√≠ usando la red interna de Docker, sin necesidad de puertos mapeados.  
Esto es ideal para simular un entorno real de empresa, donde los equipos se comunican por nombre o IP interna.

#### **Ejemplo: acceso desde un trabajador a otro**

1. **Entra en el contenedor origen** (por ejemplo, trabajador1):
   ```bash
   docker exec -it cliente-trabajador1 bash
   ```
2. **Cambia a otro usuario si quieres (opcional):**
   ```bash
   su ana
   ```
3. **Haz SSH al otro trabajador usando la IP interna:**
   ```bash
   ssh juan@192.168.0.51
   ```
   *(o usa el nombre del contenedor si tienes bien definida la red en docker-compose: `ssh juan@cliente-trabajador2`)*

4. **Pon la contrase√±a LDAP. Si la autenticaci√≥n es correcta, el sistema crear√° el home autom√°ticamente (si usas pam_mkhomedir).**

> **Nota:**  
> Puedes ver la IP interna de un contenedor ejecutando:
> ```bash
> docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' cliente-trabajador2
> ```
> Para que los nombres de contenedor funcionen como DNS, aseg√∫rate de que todos los servicios est√°n en la misma red definida en `docker-compose.yml`.

---

### üîç Pruebas y comprobaciones √∫tiles

- Verifica usuario LDAP:
  ```bash
  getent passwd juan
  ```
- Verifica grupo LDAP:
  ```bash
  getent group trabajadores
  ```
- Comprueba acceso SSH y creaci√≥n autom√°tica de home:
  ```bash
  ssh juan@localhost -p 2221
  ```
  o (desde otro contenedor):
  ```bash
  ssh juan@cliente-trabajador2
  ```

Para ver todos los usuarios LDAP con home:
```bash
getent passwd | grep /home
```

---

### ‚ö†Ô∏è Ten en cuenta

- El mapeo de puertos (ej: 2221:22) **solo es necesario para acceder desde fuera de Docker** (tu PC/host).  
  Para conexi√≥n entre contenedores, usa el puerto 22 y la IP/nombre interno.
- Si ves errores como `No route to host` al conectar entre contenedores, aseg√∫rate de que todos est√°n en la misma red de Docker (revisa tu `docker-compose.yml`).
- Si ves errores de ‚ÄúConnection closed‚Äù o ‚ÄúPermission denied‚Äù, revisa que los usuarios tengan shell v√°lido, home, y que la configuraci√≥n LDAP/PAM sea correcta.

---

**¬°Ya puedes simular un entorno de oficina realista con identidades centralizadas y acceso seguro por SSH entre todos los clientes!**

---

## ‚öôÔ∏è Scripts de Gesti√≥n y Automatizaci√≥n

- `arrancar.sh`: Arranca todos los servicios, limpia estados antiguos y verifica salud.
- `reinicio.sh`: Reinicia el entorno desde cero, asegurando limpieza y persistencia.
- `apagar.sh`: Detiene los servicios y realiza backups autom√°ticos.

Recomendaci√≥n: ejecuta siempre los scripts desde la ra√≠z del proyecto y revisa los mensajes de consola.

---

## üßë‚Äçüíª Uso y Ejemplos Pr√°cticos

- Probar la API:
  ```bash
  curl -v http://localhost:5000/api/endpoint
  ```
- Comprobar el frontend:
  ```bash
  nc -zv localhost 8080
  ```
- Entrar a la base de datos:
  ```bash
  docker exec -it <db_container> mysql -u root -p
  ```

---

## ‚úÖ Pruebas y Validaci√≥n

- Acceso web, API y base de datos desde host y contenedores
- Pruebas de autenticaci√≥n con usuarios LDAP en clientes
- Verificaci√≥n de persistencia de datos tras reinicios
- Logs y comandos de troubleshooting incluidos

---

## üõü Resoluci√≥n de Problemas

| Problema                    | Motivo t√≠pico                   | Soluci√≥n                          |
|-----------------------------|---------------------------------|-----------------------------------|
| Puerto ocupado              | Otro servicio usando el puerto  | Cambia el puerto o libera el otro |
| Permisos en vol√∫menes       | Usuario del host incorrecto     | Ajusta permisos con `chmod/chown` |
| Servicio no arranca         | Falta config o dependencias     | Mira los logs y .env              |
| Servicios no se ven         | Red Docker mal configurada      | Revisa `docker-compose.yml`       |
| LDAP sin datos              | Falta inicializaci√≥n del DN     | A√±ade LDIF o reinicia vol√∫menes   |
| SSH rechaza usuarios LDAP   | Shell inv√°lido o sin home       | Ajusta shell y pam_mkhomedir      |
| No route to host (SSH entre contenedores) | Los contenedores no comparten red Docker interna | A√±ade todos los servicios a la misma red en `docker-compose.yml` |

---

## üèÅ Conclusi√≥n Final

A lo largo de este proyecto se ha logrado desplegar y validar una infraestructura dockerizada robusta y segura, con centralizaci√≥n de identidades mediante LDAP y automatizaci√≥n de tareas administrativas. La arquitectura permite simular un entorno empresarial realista, facilitando la gesti√≥n y el aprendizaje sobre integraci√≥n de servicios, seguridad y administraci√≥n de sistemas.

---

## üôè Agradecimientos

Gracias a profesores/as, compa√±eros/as, la comunidad open source y a mi entorno personal por el apoyo durante el desarrollo de este proyecto.

---

## üöß Roadmap y Futuras Mejoras

- [ ] A√±adir tests autom√°ticos
- [ ] Mejorar los scripts de gesti√≥n
- [ ] A√±adir m√°s ejemplos pr√°cticos y documentaci√≥n avanzada
- [ ] Automatizar despliegue CI/CD
- [ ] Integrar monitorizaci√≥n y alertas

---

## üìö Referencias

1. Docker Documentation ‚Äì https://docs.docker.com/
2. OpenLDAP Administrator's Guide ‚Äì https://www.openldap.org/doc/admin24/
3. MariaDB Knowledge Base ‚Äì https://mariadb.com/kb/en/
4. Apache HTTP Server Documentation ‚Äì https://httpd.apache.org/docs/
5. Linux PAM ‚Äì https://linux-pam.org/
6. PHP LDAP Manual ‚Äì https://www.php.net/manual/en/book.ldap.php
7. Docker Compose Documentation ‚Äì https://docs.docker.com/compose/
8. LDAP System Administration, Gerald Carter, O‚ÄôReilly Media, 2003.
9. SSH Security Best Practices ‚Äì https://www.ssh.com/academy/ssh/security-best-practices

---

*¬øTienes dudas o quieres contribuir? ¬°Abre un issue o contacta!*